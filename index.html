<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Result Index (EN | JA)</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#14161c; --panel-2:#1a1d24;
      --text:#eef2ff; --muted:#9aa3b2; --accent:#7aa2ff; --border:#2a2f3a;
      --gap:16px; --maxw:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,
      "Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg,var(--panel),rgba(20,22,28,.7));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
      padding:16px;
    }
    h1{margin:0 0 6px; font-size:20px; font-weight:700}
    .hint{color:var(--muted); font-size:12px}
    main{max-width:var(--maxw); margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
    .col{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px; padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25) inset;
      min-height:120px;
    }
    .col h2{margin:0 0 10px; font-size:16px; display:flex; gap:8px; align-items:center}
    .badge{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px;
      background:var(--panel-2); color:var(--muted); border:1px solid var(--border);}
    details{
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:10px; padding:8px 10px; margin:8px 0;
    }
    summary{cursor:pointer; font-weight:700}
    ul{margin:8px 0 0 18px; padding:0; list-style:disc}
    a{
      color:var(--text); text-decoration:none; border-bottom:1px dashed rgba(122,162,255,.35);
    }
    a:hover{color:var(--accent); border-bottom-color:var(--accent)}
    .muted{color:var(--muted); font-size:12px}
    .err{color:#ff6b7a}
    footer{color:var(--muted); font-size:12px; text-align:center; padding:20px}
    @media (max-width: 800px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>Result Index <span class="muted">from <code>result/index.json</code></span></h1>
    <div class="hint">英語（左）／日本語（右）の一覧を <code>result/index.json</code> から生成します。</div>
  </header>

  <main>
    <div class="grid">
      <section class="col" id="col-en" aria-labelledby="h-en">
        <h2 id="h-en">English <span class="badge" id="count-en">0</span></h2>
        <div id="list-en" class="list"></div>
      </section>
      <section class="col" id="col-ja" aria-labelledby="h-ja">
        <h2 id="h-ja">日本語 <span class="badge" id="count-ja">0</span></h2>
        <div id="list-ja" class="list"></div>
      </section>
    </div>
  </main>

  <footer>
    Links are built as <code>result/</code> + <code>relpath</code> from <code>index.json</code>.
  </footer>

  <script>
    // 1) index.json を result/ 優先で探す（なければ同階層をフォールバック）
    async function loadIndexJSON() {
      const candidates = ["result/index.json", "./result/index.json", "index.json", "./index.json"];
      let lastErr = null;
      for (const url of candidates) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          console.log("[index.json] loaded:", url);
          return await res.json();
        } catch (e) {
          console.warn("[index.json] failed:", url, e);
          lastErr = e;
        }
      }
      throw lastErr ?? new Error("index.json not found");
    }

    // 2) JSONの relpath に "result/" を前置（既に "result/" 始まりならそのまま）
    function ensureHref(relpath) {
      if (!relpath) return "#";
      return relpath.startsWith("result/") ? relpath : `result/${relpath}`;
    }

    // 3) 各言語のブロックを描画
    function render(container, map) {
      container.innerHTML = "";
      let total = 0;
      const vids = Object.keys(map || {}).sort((a,b)=>Number(a)-Number(b));
      for (const v of vids) {
        const items = map[v] || [];
        if (!items.length) continue;
        total += items.length;

        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = `video${v} (${items.length})`;
        det.appendChild(sum);

        const ul = document.createElement("ul");
        for (const it of items) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = ensureHref(it.relpath);
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = `case${it.case}`;
          li.appendChild(a);
          ul.appendChild(li);
        }
        det.appendChild(ul);
        container.appendChild(det);
      }
      return total;
    }

    // 4) 実行
    (async () => {
      try {
        const idx = await loadIndexJSON();                    // ← result/index.json のスキーマ前提
        const en = idx?.videos?.en ?? {};
        const ja = idx?.videos?.ja ?? {};

        const enTotal = render(document.getElementById("list-en"), en);
        const jaTotal = render(document.getElementById("list-ja"), ja);

        document.getElementById("count-en").textContent = String(idx?.counts?.en ?? enTotal);
        document.getElementById("count-ja").textContent = String(idx?.counts?.ja ?? jaTotal);

        if (!enTotal) document.getElementById("list-en").innerHTML = `<p class="muted">英語ページが見つかりませんでした。</p>`;
        if (!jaTotal) document.getElementById("list-ja").innerHTML = `<p class="muted">日本語ページが見つかりませんでした。</p>`;
      } catch (e) {
        console.error(e);
        for (const key of ["en","ja"]) {
          const box = document.getElementById(`list-${key}`);
          const p = document.createElement("p");
          p.className = "err";
          p.textContent = "index.json の読み込みに失敗しました（配置やパスを確認してください）。";
          box.appendChild(p);
        }
      }
    })();
  </script>
  
</body>
</html>
